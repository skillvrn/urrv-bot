# URRV-BOT

Automated notification system for the Rostov Training Center

## CI/CD variables

| Имя переменной | Назначение |
|--------------|-----------|
| `DISCORD_ATO_NEWS_CHANNEL_ID` | ID Dicsord-канала для новостей |
| `DISCORD_TOKEN` | Discord token для доступа бота к серверу |
| `DISCORD_WELCOME_CHANNEL_ID` | ID Discord-канала приветствия  |
| `DISCORD_POSITION_ANNOUNCEMENT_CHANNEL_ID` | ID Discord-канала |
| `DOCKER_USERNAME` | Имя пользователя учетной записи в репозитории Dockerhub |
| `DOCKER_PASSWORD` | Пароль паользователя учетной записи в репозитории Dockerhub |
| `FLIGHT_ANNOUNCE_IMAGE_URL` | URL картинки анонсов |
| `PYTHON_VERSION` | Версия python (в Dockerfiles и в CI/CD) |
| `SSH_HOST` | Hostname сервера для подключения по SSH для деплоя |
| `SSH_PORT` | SSH-порт для подключения к серверу с приложением для деплоя |
| `SSH_USERNAME` | Имя SSH-пользователя на сервере с приложением для деплоя |
| `SSH_PRIVATE_KEY` | Приватный SSH-ключ пользователя для подключения к серверу с приложением для деплоя |
| `XR_SITE_URL` | URL xr ivao |

## Gitflow

### Основные приципы

* Деплой в прод производится из ветки `main` при создании нового релиза с новым тегом. Тег = версия приложения по `semver`
* В дефолтной ветке `main` всегда должен быть только стабильный код
* Ветка `develop` предназначена для разработки - в нее сливаются все фича-ветки при завершении работы над фичей
* Для начала работы над новой фичей от ветки `develop` создается новая ветка с названием `feature/FEATURE_NAME`, где `FEATURE_NAME` - короткое, понятное по смыслу название фичи, которую нужно разработать
* При завершении разработки фичи, создается pull-request и фича-ветка сливается в `develop`
* Из ветки `develop` производится деплой на сервер для проверки работы кода (автоматически при слиянии)
* Если после деплоя из ветки `develop` что-то ломается, то откатиться можно запустив последний релиз из ветки `main`
* После прохождения всех проверок кода и приложения на сервере, который был задеплоен из `develop`, созадется pull-request и ветка `develop` вливается в `main`
* Если после релиза найден баг, то от ветки `main` создается ветка `hotfix`, в ней вносятся исправления и создается pull-request, в котором ветка `hotfix` вливается в `main` и удаляется

### Инструкция по обновлению кода

* Склонировать репозиторий

```bash
git clone git@github.com:skillvrn/urrv-bot.git
```

* Перейти в рабочий каталог и переключиться на ветку разработки

```bash
cd urrv-bot
git checkout develop
```

* Если локально ветка develop уже была скачена, то чтобы получить последние изменения, выполнить:

```bash
git pull origin develop
```

* Отпочковаться от ветки `develop` в новую ветку с названием `feature/FEATURE_NAME`

```bash
git checkout -b feature/FEATURE_NAME
```

* Внести изменений в исходный код
* После окончания работ добавить информацию в `CHANGELOG.md` в формате:

```
# Changelog

## vX.Y.Z - YYYY/MM/DD
* Первое изменение
* Второе изменение
...

[Предыдущие изменения]
```

* Закомитить изменения

```bash
git commit -am "Название коммита на англ. языке"
```

* Запушить в основной git

```bash
git push -u origin feature/FEATURE_NAME
```

* Проверить в actions, что пайплайн выполняется без ошибок
* Создать Pull-request (PR) в репозитории для слияния изменений из фича-ветки в `develop`
* Провести код-ревью изменений в PR
* Получить апрув в PR
* Смержить изменения из фича-ветки в `develop`
* Проверить, что пайплайн выполняется без ошибок, приложение на сервере перезапустилось и работает

### Инструкция по созданию релиза и деплою в прод новой версии

* Убедиться, что в репозитории ветка `develop` стабильна
* Создать PR для слияния `develop` в `main`
* Провести код-ревью изменений в PR
* Получить апрув в PR
* Смержить изменения из `develop` в `main`
* Проверить в actions, что пайплайн выполняется без ошибок
* Создать новый релиз с тегом, формат версионирования по semver. Пример: v1.3.2
* Проверить, что прошел деплой на прод и все работает
